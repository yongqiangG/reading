# 线程池

## 线程池概览

### 线程池工作原理
1. 提交任务
2. 判断核心线程数
3. 判断队列数量
4. 判断最大线程数
5. 拒绝策略

图

### 为什么要区分核心线程数和最大线程数
在核心线程数和最大线程数的中间还有一个队列。如果而核心线程数够用的话，就不需要创建额外的线程，如果核心线程数设置比较小，会导致任务都添加到Queue，这时候如果没有最大线程数，就没办法创建更多的线程来处理任务。

但是如果核心线程数创建比较大的话，可能会出现一个性能问题，因为创建核心线程数时需要获取一个全局锁。

### 线程池的全局锁
当线程数小于核心线程数时，在addWorker创建新的线程时，会有一个全局的rentreenLock来控制不允许并发创建线程，只能排队添加。

## 线程池的参数

### 核心线程数

### 任务队列
建议使用有界队列。

> 无界队列的问题

1. 最大线程数失去作用，永远无法触发
2. 可能导致内存溢出
3. 不能配置饱和策略

### 最大线程数

### 饱和策略
1. 抛出异常(相对用的比较多)
2. 调用者执行
3. 丢掉队列中最后一个任务
4. 不处理，直接丢
5. 自定义策略(推荐)

### 线程保持存活时间
如果任务多，时间段，可以设置长一些，提高线程利用率

### 时间单位
配合存活时间使用

### 线程工厂
可以通过工厂给线程设置更有意义的名字

可以使用开源框架Guaua提供的ThreadFactoryBuilder

## 如何配置线程池参数
1. 分析任务特性，CPU密集型，IO密集型。CPU密集型需要分配较小的线程数，例如NCPU+1。IO密集型，可以分配较大的线程数，可能在阻塞等待IO，这时候CPU时间片还可以分配给其他线程使用，例如2NCPU+1
2. 分析任务的依赖，例如依赖数据库连接，这时候就需要考虑数据库连接数量，不应该超过数据库连接能支持的最大并发数。
3. 分析任务的优先级，例如不同的接口优先级不同，优先保证重要接口的执行效率
4. 基于压测，评估参数是否合理
5. 配置中心，应对突发的大流量场景，需要能够动态调整线程池的核心线程数和最大线程数
6. 建议使用有界队列
